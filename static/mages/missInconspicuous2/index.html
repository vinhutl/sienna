<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Miss Inconspicuous Maid Girl 2</title>
    <link rel="shortcut icon" href="TemplateData/favicon.ico">
    <link rel="stylesheet" href="TemplateData/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
      html, body {
        margin: 0;
        padding: 0;
        height: 100%;
        overflow: hidden;
        background: black;
        color: white;
        font-family: 'Montserrat', sans-serif;
      }

      #unity-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
      }

      #unity-canvas {
        width: 100%;
        height: 100%;
        display: block;
        background: #000;
      }

      #unity-loading-bar,
      #unity-warning,
      #unity-footer {
        position: absolute;
        width: 100%;
        text-align: center;
      }

      #unity-loading-bar {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
      }

      #loading-text {
        font-size: 24px;
        font-weight: 400;
        color: #ffffff;
        letter-spacing: 1px;
      }

      #unity-warning {
        top: 0;
      }

      #unity-footer {
        bottom: 0;
      }
    </style>
  </head>
  <body>
    <div id="unity-container" class="unity-desktop">
      <canvas id="unity-canvas" tabindex="-1"></canvas>

      <div id="unity-loading-bar" style="display: block;">
        <div id="loading-text">Loading game assets...</div>
      </div>

      <div id="unity-warning"></div>

      <div id="unity-footer">
        <div id="unity-logo-title-footer"></div>
        <div id="unity-fullscreen-button"></div>
        <div id="unity-build-title">MIMCO 2!</div>
      </div>
    </div>

<script>
  // Handles warning/error banners from Unity
  function unityShowBanner(msg, type) {
    const warningBanner = document.querySelector("#unity-warning");
    const div = document.createElement("div");
    div.innerHTML = msg;
    div.style.padding = "10px";
    div.style.margin = "5px";
    div.style.borderRadius = "6px";
    div.style.fontWeight = "bold";
    div.style.color = "#000";
    if (type === "error") div.style.background = "red";
    else if (type === "warning") div.style.background = "yellow";
    warningBanner.appendChild(div);
    setTimeout(() => div.remove(), 5000);
  }
</script>

<script>
  const baseUrl = "https://cdn.jsdelivr.net/gh/vinhutl/jsdelivr-cdns@main/missInconspicuous2";
  const partCount = 6;

  // Global progress tracking
  let globalProgress = 0;
  const PHASES = {
    LOADER: { weight: 0.05, start: 0 },      // 5% for loader
    DATA_MERGE: { weight: 0.85, start: 0.05 }, // 85% for data files
    UNITY_INIT: { weight: 0.10, start: 0.90 }  // 10% for Unity initialization
  };

  function updateGlobalProgress(phase, phaseProgress, customText = null) {
    const phaseInfo = PHASES[phase];
    const absoluteProgress = phaseInfo.start + (phaseProgress * phaseInfo.weight);
    globalProgress = Math.max(globalProgress, absoluteProgress);
    
    const loadingText = document.getElementById("loading-text");
    
    if (loadingText && customText) {
      loadingText.textContent = customText;
    } else if (loadingText) {
      loadingText.textContent = Math.round(globalProgress * 100) + "%";
    }
  }

  async function mergeDataFiles() {
    const parts = [];
    const loadingText = document.getElementById("loading-text");
    const progressBar = document.getElementById("unity-progress-bar-full");

    let totalDownloaded = 0;
    let totalSize = 0;

    // Pre-fetch content-lengths for better progress estimation
    const sizes = [];
    for (let i = 1; i <= partCount; i++) {
      const head = await fetch(`${baseUrl}/build5.data.part${i}`, { method: "HEAD" });
      const len = +head.headers.get("content-length");
      sizes.push(len);
      totalSize += len;
      updateGlobalProgress('DATA_MERGE', (i / partCount) * 0.1);
    }

    for (let i = 1; i <= partCount; i++) {
      const partUrl = `${baseUrl}/build5.data.part${i}`;
      console.log("Fetching", partUrl);

      const res = await fetch(partUrl);
      if (!res.ok) throw new Error(`Failed to fetch ${partUrl}: ${res.status}`);

      const reader = res.body.getReader();
      const contentLength = sizes[i - 1];
      let received = 0;
      const chunks = [];

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        chunks.push(value);
        received += value.length;
        totalDownloaded += value.length;

        // Update progress display
        const dataProgress = 0.1 + (totalDownloaded / totalSize) * 0.9;
        const mbLoaded = (totalDownloaded / 1024 / 1024).toFixed(1);
        const mbTotal = (totalSize / 1024 / 1024).toFixed(1);
        updateGlobalProgress('DATA_MERGE', dataProgress, `${mbLoaded}MB/${mbTotal}MB`);
      }

      // Concatenate chunks into full ArrayBuffer
      const partBuffer = new Uint8Array(received);
      let offset = 0;
      for (const chunk of chunks) {
        partBuffer.set(chunk, offset);
        offset += chunk.length;
      }
      parts.push(partBuffer.buffer);
    }

    // Merge all parts into one ArrayBuffer
    const totalLength = parts.reduce((a, b) => a + b.byteLength, 0);
    const merged = new Uint8Array(totalLength);
    let offset = 0;
    for (const buf of parts) {
      merged.set(new Uint8Array(buf), offset);
      offset += buf.byteLength;
    }

    console.log("Merged all data parts:", merged.byteLength);
    loadingText.textContent = "Finalizing merge...";
    return merged.buffer;
  }

  async function showGame() {
    try {
      const mergedBuffer = await mergeDataFiles();
      const blob = new Blob([mergedBuffer]);
      const dataUrl = URL.createObjectURL(blob);

      const buildUrl = "Build";
      const config = {
        arguments: [],
        dataUrl: dataUrl,
        frameworkUrl: buildUrl + "/build5.framework.js",
        codeUrl: buildUrl + "/build5.wasm",
        streamingAssetsUrl: "StreamingAssets",
        companyName: "Cinnamew",
        productName: "MIMCO 2!",
        productVersion: "1.0",
        showBanner: unityShowBanner,
      };

      const canvas = document.querySelector("#unity-canvas");
      const loadingText = document.querySelector("#loading-text");

      createUnityInstance(canvas, config, (progress) => {
        updateGlobalProgress('UNITY_INIT', progress);
      }).then((unityInstance) => {
        document.querySelector("#unity-loading-bar").style.display = "none";
        document.querySelector("#unity-fullscreen-button").onclick = () => {
          unityInstance.SetFullscreen(1);
        };
      }).catch((message) => {
        alert(message);
      });
    } catch (err) {
      console.error("Error merging data files:", err);
      alert("Failed to load data files. Check the console for details.");
    }
  }

  // Start when loader is ready
  const loaderUrl = "Build/build5.loader.js";
  const script = document.createElement("script");
  script.src = loaderUrl;
  
  // Track loader download progress
  updateGlobalProgress('LOADER', 0);
  
  script.onload = () => {
    updateGlobalProgress('LOADER', 1);
    showGame();
  };
  
  script.onerror = () => {
    document.getElementById("loading-text").textContent = "Failed to load";
    alert("Failed to load Unity loader. Please check your connection.");
  };
  
  document.body.appendChild(script);
</script>
  </body>
</html>
